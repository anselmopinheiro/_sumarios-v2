<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>{{ title or "Gestor Lectivo" }}</title>

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
      .floating-guardar {
        position: fixed;
        right: 1.5rem;
        bottom: 1.5rem;
        z-index: 1100;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      }

      .floating-nav {
        position: fixed;
        left: 1.5rem;
        bottom: 1.5rem;
        z-index: 1100;
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .sumario-status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
      }

      .sumario-status-dot.status-saved {
        background-color: #198754;
      }

      .sumario-status-dot.status-unsaved {
        background-color: #dc3545;
      }

      .sumario-status-dot.status-saving {
        background-color: #ffc107;
      }

      .table-sticky-header thead th {
        position: sticky;
        top: 0;
        z-index: 3;
        background-color: inherit;
      }
    </style>
</head>

<body class="bg-light">

<nav class="navbar navbar-dark bg-dark navbar-expand-lg mb-4">
    <div class="container">
        <a class="navbar-brand" href="/">Gestor Lectivo</a>

        <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="/anos-letivos">Anos Letivos</a></li>
            <li class="nav-item"><a class="nav-link" href="/calendario-escolar">Calendário Escolar</a></li>
            <li class="nav-item"><a class="nav-link" href="/calendario/semana">Calendário Semanal</a></li>
            <li class="nav-item"><a class="nav-link" href="/calendario/dia">Calendário Diário</a></li>
            <li class="nav-item"><a class="nav-link" href="/calendario/sumarios-pendentes">Sumários pendentes</a></li>
            <li class="nav-item"><a class="nav-link" href="/calendario/outras-datas">Outras datas</a></li>
            <li class="nav-item"><a class="nav-link" href="/calendarios/import">Importar calendário</a></li>
            <li class="nav-item"><a class="nav-link" href="/turmas">Turmas</a></li>
        </ul>
    </div>
</nav>

<div class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  (() => {
    const resize = (el) => {
      if (!el) return;
      el.style.height = 'auto';
      el.style.height = `${el.scrollHeight}px`;
    };

    const scrollKey = 'calendario-scroll-pos';
    const storeScroll = () => {
      try {
        sessionStorage.setItem(scrollKey, window.scrollY.toString());
      } catch (err) {
        console.warn('Não foi possível guardar a posição de scroll', err);
      }
    };

    const restoreScroll = () => {
      try {
        const raw = sessionStorage.getItem(scrollKey);
        if (raw !== null) {
          const pos = parseInt(raw, 10);
          if (!Number.isNaN(pos)) {
            window.scrollTo(0, pos);
          }
          sessionStorage.removeItem(scrollKey);
        }
      } catch (err) {
        console.warn('Não foi possível restaurar a posição de scroll', err);
      }
    };

    const autos = () => {
      document.querySelectorAll('textarea.js-autoresize').forEach((el) => {
        resize(el);
        el.removeEventListener('input', el._autoResizeHandler || (() => {}));
        const handler = () => resize(el);
        el._autoResizeHandler = handler;
        el.addEventListener('input', handler);
      });
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        autos();
        restoreScroll();
      });
    } else {
      autos();
      restoreScroll();
    }

    const copiarPrevisao = (btn) => {
      if (!btn) return;
      const form = btn.closest('form');
      if (!form) return;
      const previsao = form.querySelector('textarea[name="previsao"]');
      const sumario = form.querySelector('textarea[name="sumario"]');
      if (!previsao || !sumario) return;

      sumario.value = previsao.value || '';
      sumario.dispatchEvent(new Event('input', { bubbles: true }));
    };

    const bindCopias = () => {
      document.removeEventListener('click', document._copiaPrevisaoHandler || (() => {}));
      const handler = (ev) => {
        const target = ev.target.closest('.js-copy-previsao');
        if (target) {
          ev.preventDefault();
          copiarPrevisao(target);
        }
      };
      document._copiaPrevisaoHandler = handler;
      document.addEventListener('click', handler);
    };

    const obterForm = (elemento) => {
      if (!elemento) return null;
      const direto = elemento.closest('form');
      if (direto) return direto;
      if (elemento.form) return elemento.form;
      const idForm = elemento.getAttribute('form');
      return idForm ? document.getElementById(idForm) : null;
    };

    const setEstadoSumario = (form, estado, label, origem) => {
      const scope = form || origem?.closest('.js-sumario-form') || origem?.closest('tr');
      if (!scope) return;
      const dot = scope.querySelector('.js-sumario-status');
      const texto = scope.querySelector('.js-sumario-status-text');
      if (!dot || !texto) return;

      dot.classList.remove('status-saved', 'status-unsaved', 'status-saving');
      dot.classList.add(`status-${estado}`);
      texto.textContent = label;
    };

    const guardarAutomatico = async (form, origem) => {
      if (!form || form._savingSumario) return;
      form._savingSumario = true;
      setEstadoSumario(form, 'saving', 'A guardar...', origem);

      try {
        const resp = await fetch(form.action, {
          method: (form.method || 'post').toUpperCase(),
          body: new FormData(form),
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            Accept: 'application/json',
          },
        });

        if (!resp.ok) {
          throw new Error('Resposta inválida ao guardar');
        }

        setEstadoSumario(form, 'saved', 'Guardado', origem);
      } catch (err) {
        console.error(err);
        setEstadoSumario(form, 'unsaved', 'Erro ao guardar', origem);
      } finally {
        form._savingSumario = false;
      }
    };

    const bindAutosave = () => {
      document.querySelectorAll('form.js-sumario-form').forEach((form) => {
        if (form._autosaveBound) return;
        const sumario = form.querySelector('textarea[name="sumario"]');
        if (!sumario) return;

        const marcarPorGuardar = () => setEstadoSumario(form, 'unsaved', 'Alterações por guardar');

        sumario.addEventListener('input', marcarPorGuardar);
        sumario.addEventListener('change', marcarPorGuardar);
        sumario.addEventListener('blur', () => guardarAutomatico(form, sumario));

        form._autosaveBound = true;
      });

      document.querySelectorAll('select[name="tipo"]').forEach((select) => {
        if (select._autosaveBound) return;
        const form = obterForm(select);
        if (!form) return;

        select.addEventListener('change', () => {
          setEstadoSumario(form, 'unsaved', 'Alterações por guardar', select);
          guardarAutomatico(form, select);
        });

        select._autosaveBound = true;
      });
    };

    const guardarTodos = async (btn) => {
      if (!btn) return;
      const selector = btn.dataset.formsSelector || 'form.js-sumario-form';
      const scope = btn.dataset.scope ? document.querySelector(btn.dataset.scope) : document;
      const forms = Array.from(scope ? scope.querySelectorAll(selector) : []);
      if (!forms.length) return;

      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = btn.dataset.loadingText || 'A guardar...';

      try {
        storeScroll();
        for (const form of forms) {
          const method = (form.method || 'post').toUpperCase();
          const resp = await fetch(form.action, {
            method,
            body: new FormData(form),
          });
          if (!resp.ok) {
            throw new Error(`Erro ao guardar o registo ${form.action}`);
          }
        }
        window.location.reload();
      } catch (err) {
        console.error(err);
        btn.innerHTML = btn.dataset.errorText || 'Falha ao guardar';
        setTimeout(() => {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }, 2000);
      }
    };

    const bindGuardarTodos = () => {
      document.removeEventListener('click', document._guardarTodosHandler || (() => {}));
      const handler = (ev) => {
        const target = ev.target.closest('.js-guardar-todos');
        if (target) {
          ev.preventDefault();
          guardarTodos(target);
        }
      };
      document._guardarTodosHandler = handler;
      document.addEventListener('click', handler);
    };

    document.addEventListener('submit', (ev) => {
      if (ev.target && ev.target.closest('form.js-sumario-form')) {
        storeScroll();
      }
    });
    window.addEventListener('beforeunload', storeScroll);

    const onReady = () => {
      bindCopias();
      bindGuardarTodos();
      bindAutosave();
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', onReady);
    } else {
      onReady();
    }
  })();
</script>

</body>
</html>
