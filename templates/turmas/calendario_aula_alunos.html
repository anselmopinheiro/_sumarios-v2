{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h2>Avaliação de alunos</h2>
    <p class="mb-0 text-muted">
      Turma {{ turma.nome }} &mdash; {{ aula.data.strftime('%d/%m/%Y') }}
      {% if aula.modulo %}
        &bull; {{ aula.modulo.nome }}
      {% endif %}
    </p>
  </div>
  <div class="d-flex gap-2">
    {% if return_url %}
      <a href="{{ return_url }}" class="btn btn-outline-secondary">Voltar</a>
    {% else %}
      <a href="{{ url_for('turma_calendario', turma_id=turma.id) }}" class="btn btn-outline-secondary">Voltar</a>
    {% endif %}
  </div>
</div>

{% if ano_fechado %}
  <div class="alert alert-warning">Ano letivo fechado: apenas leitura.</div>
{% endif %}

<div class="card">
  <div class="card-body">
    <h5 class="card-title">Pontualidade, faltas e desempenho</h5>
    <p class="text-muted">Pontualidade: selecione quando o aluno chegou com atraso. Falta: número de tempos (0-6). As restantes avaliações variam de 1 a 5 (valor pré-definido 3).</p>
    <form method="post">
      {% if return_url %}
        <input type="hidden" name="return_url" value="{{ return_url }}">
      {% endif %}
      <div class="alert alert-secondary d-flex align-items-center justify-content-between">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="atividade_flag" name="atividade_flag" value="1" {% if aula.atividade %}checked{% endif %} {% if ano_fechado %}disabled{% endif %}>
          <label class="form-check-label" for="atividade_flag">Esta aula tem atividade</label>
        </div>
        <div class="ms-3 flex-grow-1">
          <label class="form-label mb-1" for="atividade_nome">Nome da atividade (mostrado no mapa de atividades)</label>
          <input type="text" class="form-control" id="atividade_nome" name="atividade_nome" value="{{ aula.atividade_nome or '' }}" {% if not aula.atividade %}disabled{% endif %} {% if ano_fechado %}disabled{% endif %}>
        </div>
      </div>
      <div class="table-responsive table-sticky-wrapper">
        <table class="table table-striped table-hover align-middle table-sticky-header">
          <thead class="table-dark">
            <tr>
              <th>Nº</th>
              <th>Nome</th>
              <th class="text-center">Atraso</th>
              <th style="width: 110px;">Faltas</th>
              <th class="text-center">Responsabilidade</th>
              <th class="text-center">Comportamento</th>
              <th class="text-center">Participação</th>
              <th class="text-center">Trabalho autónomo</th>
              <th class="text-center">Portátil/Material</th>
              <th class="text-center">Atividade</th>
            </tr>
          </thead>
          <tbody>
            {% for aluno in alunos %}
              {% set avaliacao = avaliacoes.get(aluno.id) %}
              <tr>
                <td style="width: 70px;">{{ aluno.numero or '' }}</td>
                <td>{{ aluno.nome }}</td>
                <td class="text-center">
                  <div class="form-check d-inline-block">
                    <input class="form-check-input" type="checkbox" name="atraso_{{ aluno.id }}" id="atraso_{{ aluno.id }}" {% if avaliacao and avaliacao.atraso %}checked{% endif %} {% if ano_fechado %}disabled{% endif %}>
                    <label class="form-check-label" for="atraso_{{ aluno.id }}">Atraso</label>
                  </div>
                </td>
                <td style="max-width: 110px;">
                  <input type="number" name="faltas_{{ aluno.id }}" class="form-control form-control-sm" min="0" max="6" value="{{ avaliacao.faltas if avaliacao else 0 }}" {% if ano_fechado %}disabled{% endif %}>
                </td>
                {% for campo in ["responsabilidade", "comportamento", "participacao", "trabalho_autonomo", "portatil_material", "atividade"] %}
                  {% set valor_bruto = avaliacao|attr(campo) if avaliacao else None %}
                  {% set valor = valor_bruto if valor_bruto is not none else 3 %}
                  <td class="text-center">
                    <select name="{{ campo }}_{{ aluno.id }}" class="form-select form-select-sm" {% if ano_fechado %}disabled{% endif %}>
                      <option value="">&mdash;</option>
                      {% for n in range(1,6) %}
                        <option value="{{ n }}" {% if valor==n %}selected{% endif %}>{{ n }}</option>
                      {% endfor %}
                    </select>
                  </td>
                {% endfor %}
              </tr>
            {% else %}
              <tr>
                <td colspan="10" class="text-center text-muted">Nenhum aluno registado.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="d-flex justify-content-end">
        <button type="submit" class="btn btn-primary" {% if ano_fechado or not alunos %}disabled{% endif %}>Guardar avaliações</button>
      </div>
    </form>
  </div>
</div>
<script>
  const atividadeFlag = document.getElementById('atividade_flag');
  const atividadeNome = document.getElementById('atividade_nome');
  function toggleAtividadeNome() {
    if (!atividadeFlag || !atividadeNome) return;
    const ativo = atividadeFlag.checked;
    atividadeNome.disabled = !ativo || atividadeFlag.hasAttribute('disabled');
    if (ativo) {
      atividadeNome.classList.remove('opacity-50');
    } else {
      atividadeNome.classList.add('opacity-50');
    }
  }
  if (atividadeFlag) {
    atividadeFlag.addEventListener('change', toggleAtividadeNome);
    toggleAtividadeNome();
  }
</script>
{% endblock %}
