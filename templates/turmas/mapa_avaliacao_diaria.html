{% extends "base.html" %}
{% block content %}
<h2>Mapa diário de avaliação — {{ turma.nome }}</h2>
{% if ano %}
  <p class="text-muted">Ano letivo: {{ ano.nome }}</p>
{% endif %}

<form method="get" class="row g-3 mb-3">
  <div class="col-md-3">
    <label class="form-label">Período</label>
    <select name="periodo_id" class="form-select" onchange="this.form.submit()">
      {% for p in periodos_disponiveis %}
        <option value="{{ p.id }}" {% if periodo_atual and p.id == periodo_atual.id %}selected{% endif %}>
          {{ p.nome }} ({{ p.data_inicio.strftime('%d/%m/%Y') }} – {{ p.data_fim.strftime('%d/%m/%Y') }})
        </option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Módulo</label>
    <select name="modulo_id" class="form-select" onchange="this.form.submit()">
      <option value="">Todos</option>
      {% for modulo in modulos %}
        <option value="{{ modulo.id }}" {% if modulo_id and modulo_id == modulo.id %}selected{% endif %}>{{ modulo.nome }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Data inicial</label>
    <input type="date" name="data_inicio" class="form-control" value="{{ data_inicio.isoformat() if data_inicio else '' }}">
  </div>
  <div class="col-md-3">
    <label class="form-label">Data final</label>
    <div class="d-flex gap-2">
      <input type="date" name="data_fim" class="form-control" value="{{ data_fim.isoformat() if data_fim else '' }}">
      <button type="submit" class="btn btn-primary">Filtrar</button>
    </div>
  </div>
</form>

<div class="mb-3">
  <a href="{{ url_for('turma_calendario', turma_id=turma.id, periodo_id=periodo_atual.id if periodo_atual else None) }}" class="btn btn-secondary">← Voltar ao calendário</a>
  <a
    href="{{ url_for('turma_mapa_avaliacao_diaria_export', turma_id=turma.id, periodo_id=periodo_atual.id if periodo_atual else None, modulo_id=modulo_id if modulo_id else None, data_inicio=data_inicio.isoformat() if data_inicio else None, data_fim=data_fim.isoformat() if data_fim else None) }}"
    class="btn btn-outline-success ms-2"
  >
    Exportar XLS
  </a>
</div>

{% if not dias and not atividades %}
  <div class="alert alert-info">Não existem aulas no intervalo selecionado.</div>
{% endif %}

{% if dias %}
  {% set datas = dias %}
  <h4 class="mt-4">Mapa diário (Responsabilidade, Comportamento, Participação, Trabalho autónomo, Portátil/Material)</h4>
  <div class="small text-muted mb-2">
    <span class="badge bg-danger-subtle text-danger border border-danger-subtle">Legenda</span>
    Células a vermelho indicam falta disciplinar (média automática de 1, conta para a média final).
  </div>
  <style>
    .mapa-avaliacao-table .sticky-col {
      position: sticky;
      left: 0;
      z-index: 2;
      background: var(--bs-body-bg);
    }

    .mapa-avaliacao-table thead .sticky-col {
      z-index: 4;
    }

    .mapa-avaliacao-table .col-faltas {
      background-color: #f8d7da;
    }

    .mapa-avaliacao-table .col-pontualidade {
      background-color: #fff3cd;
    }
  </style>
  <div class="table-responsive table-sticky-wrapper mt-3">
    <table class="table table-striped table-bordered table-hover align-middle table-sticky-header mapa-avaliacao-table">
      <thead class="table-dark">
        <tr>
          <th class="sticky-col" style="width: 70px;">#</th>
          <th class="sticky-col" style="min-width: 240px;">Aluno</th>
          {% for dia in datas %}
            {% set danger = 'table-danger' if dia.tem_falta_disciplinar else '' %}
            <th class="text-center {{ danger }}">
              {{ dia.data.strftime('%d/%m/%Y') }}
              {% if dia.sumarios %}<br><small>N.º {{ dia.sumarios }}</small>{% endif %}
              {% if dia.tem_falta_disciplinar %}<br><small class="text-danger fw-semibold">Falta disciplinar</small>{% endif %}
            </th>
          {% endfor %}
          <th class="text-center col-faltas" style="width: 120px;">Faltas</th>
          <th class="text-center col-pontualidade" style="width: 140px;">Pontualidade</th>
          <th class="text-end" style="width: 140px;">Média</th>
        </tr>
      </thead>
      <tbody>
        {% for aluno in alunos %}
          {% set ns = namespace(valores=[], faltas_total=0, atrasos_total=0) %}
          <tr>
            <td class="sticky-col">{{ aluno.numero if aluno.numero is not none else '--' }}</td>
            <td class="sticky-col">{{ aluno.nome }}</td>
            {% for dia in dias %}
              {% set falta_disc = dia.get('falta_disciplinar_por_aluno', {}).get(aluno.id) %}
              {% set danger = 'table-danger' if falta_disc else '' %}
              {% set media = dia.medias.get(aluno.id) %}
              {% if media is not none %}
                {% set _ = ns.valores.append(media) %}
              {% endif %}
              <td class="text-center {{ danger }}">
                {% if media is none %}
                  —
                {% else %}
                  {{ '%.2f'|format(media) }}
                {% endif %}
              </td>
              {% set ns.faltas_total = ns.faltas_total + (dia.faltas.get(aluno.id) or 0) %}
              {% set ns.atrasos_total = ns.atrasos_total + (dia.atrasos.get(aluno.id) or 0) %}
            {% endfor %}
            <td class="text-center col-faltas">{{ ns.faltas_total }}</td>
            <td class="text-center col-pontualidade">{{ ns.atrasos_total }}</td>
            <td class="text-end fw-semibold">
              {% if ns.valores %}
                {{ '%.2f'|format((ns.valores | sum) / (ns.valores | length)) }}
              {% else %}
                —
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endif %}

{% if atividades %}
  <h4 class="mt-4" id="mapa-atividades">Mapa de atividades</h4>
  <div class="table-responsive table-sticky-wrapper mt-3">
    <table class="table table-striped table-bordered table-hover align-middle table-sticky-header">
      <thead class="table-secondary">
        <tr>
          <th style="width: 70px;">#</th>
          <th style="min-width: 240px;">Aluno</th>
          {% for at in atividades %}
            <th class="text-center">{{ at.data.strftime('%d/%m/%Y') }}{% if at.titulo %}<br><small>{{ at.titulo }}</small>{% endif %}</th>
          {% endfor %}
          <th class="text-end" style="width: 140px;">Média atividades</th>
        </tr>
      </thead>
      <tbody>
        {% for aluno in alunos %}
          {% set ns = namespace(valores=[]) %}
          <tr>
            <td>{{ aluno.numero if aluno.numero is not none else '--' }}</td>
            <td>{{ aluno.nome }}</td>
            {% for at in atividades %}
              {% set nota = at.notas.get(aluno.id) %}
              {% if nota is not none %}
                {% set _ = ns.valores.append(nota) %}
              {% endif %}
              <td class="text-center">
                {% if nota is none %}
                  —
                {% else %}
                  {{ '%.2f'|format(nota) }}
                {% endif %}
              </td>
            {% endfor %}
            <td class="text-end fw-semibold">
              {% if ns.valores %}
                {{ '%.2f'|format((ns.valores | sum) / (ns.valores | length)) }}
              {% else %}
                —
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endif %}
{% endblock %}
