{% extends "base.html" %}
{% block content %}
<h2>Mapa diário de avaliação — {{ turma.nome }}</h2>
{% if ano %}
  <p class="text-muted">Ano letivo: {{ ano.nome }}</p>
{% endif %}

<form method="get" class="row g-3 mb-3">
  <div class="col-md-4">
    <label class="form-label">Período</label>
    <select name="periodo_id" class="form-select" onchange="this.form.submit()">
      {% for p in periodos_disponiveis %}
        <option value="{{ p.id }}" {% if periodo_atual and p.id == periodo_atual.id %}selected{% endif %}>
          {{ p.nome }} ({{ p.data_inicio.strftime('%d/%m/%Y') }} – {{ p.data_fim.strftime('%d/%m/%Y') }})
        </option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-4">
    <label class="form-label">Data inicial</label>
    <input type="date" name="data_inicio" class="form-control" value="{{ data_inicio.isoformat() if data_inicio else '' }}">
  </div>
  <div class="col-md-4">
    <label class="form-label">Data final</label>
    <div class="d-flex gap-2">
      <input type="date" name="data_fim" class="form-control" value="{{ data_fim.isoformat() if data_fim else '' }}">
      <button type="submit" class="btn btn-primary">Filtrar</button>
    </div>
  </div>
</form>

<div class="mb-3">
  <a href="{{ url_for('turma_calendario', turma_id=turma.id, periodo_id=periodo_atual.id if periodo_atual else None) }}" class="btn btn-secondary">← Voltar ao calendário</a>
</div>

{% if not dias %}
  <div class="alert alert-info">Não existem aulas no intervalo selecionado.</div>
{% else %}
  {% for dia in dias %}
    <h4 class="mt-4">{{ dia.data.strftime('%d/%m/%Y') }}</h4>
    <div class="table-responsive">
      <table class="table table-striped table-bordered align-middle">
        <thead class="table-dark">
          <tr>
            <th style="width: 80px;">N.º</th>
            <th>Aluno</th>
            <th style="width: 160px;" class="text-end">Média do dia</th>
          </tr>
        </thead>
        <tbody>
          {% for aluno in alunos %}
            {% set media = dia.medias.get(aluno.id) %}
            <tr>
              <td>{{ aluno.numero if aluno.numero is not none else '--' }}</td>
              <td>{{ aluno.nome }}</td>
              <td class="text-end">
                {% if media is none %}
                  —
                {% else %}
                  {{ '%.2f'|format(media) }}
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endfor %}
{% endif %}
{% endblock %}
