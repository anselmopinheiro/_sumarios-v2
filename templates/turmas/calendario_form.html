{% extends "base.html" %}
{% block content %}

<h2>{{ titulo }}</h2>

<p class="text-muted">
  Turma: {{ turma.nome }}<br>
  Período: {{ periodo.nome or (periodo.data_inicio|string + " - " + periodo.data_fim|string) }}
</p>

<form method="post">
  {% if redirect_view in ['dia', 'semana'] and data_ref %}
    <input type="hidden" name="view" value="{{ redirect_view }}">
    <input type="hidden" name="data_ref" value="{{ data_ref }}">
    {% set turma_hidden = request.values.get('turma_id') or request.values.get('turma_filtro') %}
    {% if turma_hidden %}
      <input type="hidden" name="turma_id" value="{{ turma_hidden }}">
    {% endif %}
  {% endif %}

  <div class="mb-3">
    <label class="form-label">Data</label>
    <input type="date" name="data" class="form-control"
           value="{{ aula.data.isoformat() if aula and aula.data }}">
  </div>

  <div class="mb-3">
    <label class="form-label">Módulo</label>
    <select name="modulo_id" class="form-select" required>
      <option value="">-- escolher --</option>
      {% for m in modulos %}
        <option value="{{ m.id }}"
          {% if aula and aula.modulo_id == m.id %}selected{% endif %}>
          {{ m.nome }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="row">
    <div class="col-md-4 mb-3">
      <label class="form-label">Nº Aula no Módulo</label>
      <input type="number" name="numero_modulo" class="form-control"
             value="{{ aula.numero_modulo if aula and aula.numero_modulo is not none else '' }}">
    </div>

    <div class="col-md-4 mb-3">
      <label class="form-label">Total Global até aqui</label>
      <input type="number" name="total_geral" class="form-control"
             value="{{ aula.total_geral if aula and aula.total_geral is not none else '' }}">
    </div>

    <div class="col-md-3 mb-3">
      <label class="form-label">Tipo</label>
      <select name="tipo" class="form-select" id="tipo-select">
        {% set valor_tipo = aula.tipo if aula else "normal" %}
        {% for valor, label in tipos_aula %}
          <option value="{{ valor }}" {% if valor_tipo == valor %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3 mb-3">
      {% set sumarios_limpos = (aula.sumarios or '').split(',')|map('trim')|reject('equalto','')|list if aula else [] %}
      {% set total_base = sumarios_limpos|length if sumarios_limpos|length > 0 else 1 %}
      {% set total_previsto = [total_base, aula.tempos_sem_aula or 0 if aula else 0]|max %}
      {% if total_previsto < 1 %}{% set total_previsto = 1 %}{% endif %}
      {% set tempos_default = aula.tempos_sem_aula if aula and aula.tempos_sem_aula is not none else (total_previsto if aula and aula.tipo in tipos_sem_aula else 0) %}
      {% set tempos_default = [tempos_default, total_previsto]|max %}
      <label class="form-label">Tempos sem aula</label>
      <input type="number"
             name="tempos_sem_aula"
             id="tempos-sem-aula"
             class="form-control"
             min="0"
             value="{{ tempos_default or 0 }}"
             data-total-previsto="{{ total_previsto }}"
             data-tempos-atual="{{ tempos_default or 0 }}">
      <div class="form-text">Usado em faltei/serviço oficial/outros para indicar quantos tempos não contam.</div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6 mb-3">
      <label class="form-label">Nº Sumário(s) (lista de números, ex.: 1,2,3)</label>
      <input type="text" name="sumarios" class="form-control"
             value="{{ aula.sumarios if aula and aula.sumarios else '' }}">
    </div>

    <div class="col-md-6 mb-3">
      <label class="form-label">Sumário (descrição da aula)</label>
      <div class="d-flex flex-column gap-2">
        <textarea name="sumario" class="form-control js-autoresize" rows="3"
                  placeholder="Breve descrição da aula">{{ aula.sumario if aula and aula.sumario else '' }}</textarea>
        <div class="d-flex gap-2 flex-wrap">
          <button type="button" class="btn btn-outline-secondary btn-sm js-copy-sumario">Copiar sumário</button>
          {% if sumario_anterior %}
            <button type="button"
                    class="btn btn-outline-info btn-sm js-use-prev-sumario"
                    data-sumario-anterior="{{ sumario_anterior }}">
              Usar sumário anterior
            </button>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-md-6 mb-3">
      <label class="form-label">Previsão (planeamento)</label>
      {% set previsao_id = "previsao-" ~ (aula.id if aula else 'nova') %}
      <div class="js-richtext-wrapper d-flex flex-column gap-1">
        <div class="richtext-toolbar d-flex flex-wrap align-items-center gap-2">
          <span class="small text-muted">Formatação:</span>
          <button type="button" class="btn btn-outline-secondary btn-sm js-richtext-cmd" data-command="bold"><strong>B</strong></button>
          <button type="button" class="btn btn-outline-secondary btn-sm js-richtext-cmd" data-command="italic"><em>I</em></button>
          <button type="button" class="btn btn-outline-secondary btn-sm js-richtext-cmd" data-command="backColor" data-value="#fff3cd"><span class="px-1" style="background: #fff3cd;">Realçar</span></button>
        </div>
        <div
          class="form-control js-richtext-editor richtext-editor"
          contenteditable="true"
          data-target="#{{ previsao_id }}"
          aria-label="Plano para a aula"
        >{{ aula.previsao if aula and aula.previsao else '' }}</div>
        <input type="hidden" name="previsao" id="{{ previsao_id }}" value="{{ aula.previsao if aula and aula.previsao else '' }}" data-turma-id="{{ aula.turma_id if aula else turma.id }}" data-sort-key="{{ aula.data.isoformat() if aula and aula.data else '' }}-{{ '%06d' % aula.id if aula else '000000' }}">
        <div class="form-text">Suporta negrito, itálico e destaque amarelo.</div>
      </div>
      <button type="button" class="btn btn-link btn-sm ps-0 js-copy-previsao">Copiar previsão para sumário</button>
      {% if aula %}
        <button type="submit" class="btn btn-link btn-sm ps-0" form="previsao-limpar-{{ aula.id }}">Limpar</button>
        <button type="submit" class="btn btn-link btn-sm ps-0" form="previsao-anterior-{{ aula.id }}">Copiar anterior</button>
        <button type="submit" class="btn btn-link btn-sm ps-0" form="previsao-seguinte-{{ aula.id }}">Enviar p/ seguinte</button>
      {% endif %}
    </div>
  </div>

  <button type="submit" class="btn btn-success">Guardar</button>
  {% if redirect_view == 'dia' and data_ref %}
    {% set turma_hidden = request.values.get('turma_filtro') %}
    <a href="{{ url_for('turma_calendario_dia', data=data_ref, turma_id=turma_hidden) }}"
       class="btn btn-secondary">
      Cancelar
    </a>
  {% elif redirect_view == 'semana' %}
    {% set turma_hidden = request.values.get('turma_id') or request.values.get('turma_filtro') %}
    <a href="{{ url_for('calendario_semana', data=data_ref, turma_id=turma_hidden) }}"
       class="btn btn-secondary">
      Cancelar
    </a>
  {% else %}
    <a href="{{ url_for('turma_calendario',
                        turma_id=turma.id,
                        periodo_id=periodo.id) }}"
       class="btn btn-secondary">
      Cancelar
    </a>
  {% endif %}

  {% if aula %}
    <form method="post" id="previsao-limpar-{{ aula.id }}" action="{{ url_for('previsao_limpar', turma_id=aula.turma_id, aula_id=aula.id) }}" class="d-none">
      <input type="hidden" name="periodo_id" value="{{ aula.periodo_id }}">
    </form>
    <form method="post" id="previsao-anterior-{{ aula.id }}" action="{{ url_for('previsao_copiar_anterior', turma_id=aula.turma_id, aula_id=aula.id) }}" class="d-none">
      <input type="hidden" name="periodo_id" value="{{ aula.periodo_id }}">
    </form>
    <form method="post" id="previsao-seguinte-{{ aula.id }}" action="{{ url_for('previsao_enviar_seguinte', turma_id=aula.turma_id, aula_id=aula.id) }}" class="d-none">
      <input type="hidden" name="periodo_id" value="{{ aula.periodo_id }}">
    </form>
  {% endif %}
</form>

<script>
  (() => {
    const tiposSemAula = {{ tipos_sem_aula|list|tojson }};
    const select = document.getElementById('tipo-select');
    const temposInput = document.getElementById('tempos-sem-aula');

    function sincronizarTemposForm() {
      if (!select || !temposInput) return;
      const isSemAula = tiposSemAula.includes(select.value);

      if (isSemAula) {
        temposInput.readOnly = false;
        temposInput.classList.remove('bg-light', 'text-muted');
        if (!temposInput.value) {
          const fallback = temposInput.dataset.temposAtual || temposInput.dataset.totalPrevisto || '0';
          temposInput.value = fallback;
        }
      } else {
        temposInput.value = 0;
        temposInput.readOnly = true;
        temposInput.classList.add('bg-light', 'text-muted');
      }
    }

    sincronizarTemposForm();
    if (select) {
      select.addEventListener('change', sincronizarTemposForm);
    }
  })();
</script>

{% endblock %}
