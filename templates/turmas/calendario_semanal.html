{% extends "base.html" %}
{% block content %}

<h2>Calendário Semanal</h2>

<form method="get" class="row g-3 align-items-end mb-3">
  <div class="col-12 col-md-4">
    <label class="form-label">Data de referência</label>
    <input type="date" name="data" class="form-control" value="{{ data_base.isoformat() }}">
  </div>
  <div class="col-12 col-md-4">
    <label class="form-label">Filtrar por turma</label>
    <select name="turma_id" class="form-select">
      <option value="">Todas as turmas</option>
      {% for t in turmas %}
        <option value="{{ t.id }}" {% if turma and turma.id == t.id %}selected{% endif %}>{{ t.nome }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-12 col-md-4 d-flex gap-2">
    <button type="submit" class="btn btn-primary mt-auto">Atualizar</button>
    {% if turma %}
      <a href="{{ url_for('turma_calendario', turma_id=turma.id) }}" class="btn btn-outline-secondary mt-auto">Calendário da turma</a>
    {% endif %}
  </div>
</form>

<div class="d-flex flex-wrap gap-2 align-items-end mb-3">
  <div class="d-flex align-items-center gap-2">
    <a class="btn btn-outline-primary"
       href="{{ url_for('calendario_semana', turma_id=turma.id if turma else None, data=semana_anterior.isoformat()) }}">◀ Semana anterior</a>
    <a class="btn btn-outline-primary"
       href="{{ url_for('calendario_semana', turma_id=turma.id if turma else None, data=semana_seguinte.isoformat()) }}">Semana seguinte ▶</a>
  </div>
  <form method="get" class="d-flex align-items-center gap-2">
    {% if turma %}
      <input type="hidden" name="turma_id" value="{{ turma.id }}">
    {% endif %}
    <label class="form-label mb-0">Ir para data:</label>
    <input type="date" name="data" class="form-control" value="{{ data_base.isoformat() }}">
    <button type="submit" class="btn btn-primary">Ir</button>
  </form>
</div>

{% for dia in dias_semana %}
  <h1 class="h4 mt-4">{{ dia.strftime('%d/%m/%Y') }}</h1>
  <div class="text-muted mb-2">{{ ["Seg", "Ter", "Qua", "Qui", "Sex", "Sáb", "Dom"][dia.weekday()] }}</div>
  {% set aulas = aulas_por_data.get(dia, []) %}
  {% if aulas %}
    <table class="table table-striped table-bordered align-middle">
      <thead class="table-dark">
        <tr>
          <th style="width: 65%;">Sumário</th>
          <th>Tipo</th>
          <th style="width: 160px;">Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for a in aulas %}
          {% set sumarios_limpos = (a.sumarios or '').split(',')|map('trim')|reject('equalto','')|list %}
          {% set total_previsto = sumarios_limpos|length if sumarios_limpos|length > 0 else 1 %}
          {% set faltas = a.tempos_sem_aula if a.tempos_sem_aula is not none else (total_previsto if a.tipo in tipos_sem_aula else 0) %}
          {% set faltas = [faltas, total_previsto]|min %}
          {% set faltas = [faltas, 0]|max %}
          {% set sem_aula = a.tipo in tipos_sem_aula %}
          {% set sem_aula_total = sem_aula and faltas >= total_previsto %}
          {% set form_id = "semana-form-" ~ a.id %}
          {% set turma_fechada = anos_fechados.get(a.turma_id, False) %}
          <tr>
            <td class="w-100">
              <div class="d-flex flex-wrap gap-1 mb-2">
                <span class="badge rounded-pill bg-body-secondary text-dark border border-secondary-subtle">Turma {{ a.turma.nome if a.turma else '—' }}</span>
                <span class="badge rounded-pill bg-body-secondary text-dark border border-secondary-subtle">
                  Nº Sumário {% if sem_aula %}—{% else %}{{ a.sumarios or '—' }}{% endif %}
                </span>
                <span class="badge rounded-pill bg-body-secondary text-dark border border-secondary-subtle">
                  {{ dia.strftime('%d/%m/%Y') }}
                  <small class="text-muted ms-1">{{ ["Seg", "Ter", "Qua", "Qui", "Sex", "Sáb", "Dom"][dia.weekday()] }}</small>
                </span>
                <span class="badge rounded-pill bg-body-secondary text-dark border border-secondary-subtle">
                  {% if a.modulo %}{{ a.modulo.nome }}{% else %}Sem módulo{% endif %}
                </span>
                <span class="badge rounded-pill bg-body-secondary text-dark border border-secondary-subtle">
                  Aula {% if sem_aula_total %}—{% else %}{{ a.numero_modulo or '—' }}{% endif %}
                </span>
                <span class="badge rounded-pill bg-body-secondary text-dark border border-secondary-subtle">
                  Total {% if sem_aula_total %}—{% else %}{{ a.total_geral or '—' }}{% endif %}
                </span>
              </div>

              {% if turma_fechada %}
                {{ a.sumario or '' }}
              {% else %}
                <form method="post"
                      id="{{ form_id }}"
                      action="{{ url_for('calendario_update_sumario', turma_id=a.turma_id, aula_id=a.id) }}"
                      class="d-flex flex-column gap-2">
                  <input type="hidden" name="view" value="semana">
                  <input type="hidden" name="data_ref" value="{{ semana_inicio.isoformat() }}">
                  {% if turma %}
                    <input type="hidden" name="turma_id" value="{{ turma.id }}">
                  {% endif %}
                  <div class="d-flex align-items-start gap-2">
                    <textarea name="sumario"
                              class="form-control form-control-sm"
                              rows="2"
                              placeholder="Escrever sumário...">{{ a.sumario or '' }}</textarea>
                    <div class="d-flex flex-column" style="width: 120px;">
                      <label class="form-label form-label-sm mb-1">Tempos (sem aula)</label>
                      <input type="number"
                             name="tempos_sem_aula"
                             form="{{ form_id }}"
                             class="form-control form-control-sm"
                             min="0"
                             value="{{ faltas if sem_aula else total_previsto }}">
                    </div>
                  </div>
                </form>
              {% endif %}
            </td>
            <td>
              {% if turma_fechada %}
                {{ a.tipo }}
              {% else %}
                <div class="d-flex align-items-start gap-2">
                  <select name="tipo"
                          form="{{ form_id }}"
                          class="form-select form-select-sm">
                    {% for valor, label in tipos_aula %}
                      <option value="{{ valor }}" {% if a.tipo == valor %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                  <button type="submit" form="{{ form_id }}" class="btn btn-sm btn-primary">Guardar</button>
                </div>
              {% endif %}
            </td>
            <td>
              {% if turma_fechada %}
                <span class="text-muted">—</span>
              {% else %}
                <a href="{{ url_for('calendario_edit', turma_id=a.turma_id, aula_id=a.id, view='semana', data_ref=semana_inicio.isoformat(), turma_filtro=turma.id if turma else None) }}"
                   class="btn btn-sm btn-warning">Editar</a>
                <form method="post"
                      action="{{ url_for('calendario_delete', turma_id=a.turma_id, aula_id=a.id) }}"
                      style="display:inline"
                      onsubmit="return confirm('Apagar esta linha de calendário?');">
                  <input type="hidden" name="view" value="semana">
                  <input type="hidden" name="data_ref" value="{{ semana_inicio.isoformat() }}">
                  {% if turma %}
                    <input type="hidden" name="turma_id" value="{{ turma.id }}">
                  {% endif %}
                  <button type="submit" class="btn btn-sm btn-danger">Apagar</button>
                </form>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <div class="alert alert-info">Não existem aulas para esta data.</div>
  {% endif %}
{% endfor %}

{% endblock %}
