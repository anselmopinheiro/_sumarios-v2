{% extends "base.html" %}
{% block content %}

<h2>Calendário semanal — Previsões</h2>

<form method="get" class="row g-3 align-items-end mb-3">
  <div class="col-12 col-md-4">
    <label class="form-label">Data de referência</label>
    <input type="date" name="data" class="form-control" value="{{ data_base.isoformat() }}">
  </div>
  <div class="col-12 col-md-4">
    <label class="form-label">Filtrar por turma</label>
    <select name="turma_id" class="form-select">
      <option value="">Todas as turmas</option>
      {% for t in turmas %}
        <option value="{{ t.id }}" {% if turma and turma.id == t.id %}selected{% endif %}>{{ t.nome }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-12 col-md-4">
    <div class="form-check mt-4">
      <input class="form-check-input" type="checkbox" id="mostrar_todas" name="mostrar_todas" value="1"
             {% if mostrar_todas %}checked{% endif %}>
      <label class="form-check-label" for="mostrar_todas">Mostrar turmas não letivas</label>
    </div>
  </div>
  {% if turma and periodos_disponiveis %}
    <div class="col-12 col-md-4">
      <label class="form-label">Período</label>
      <select name="periodo_id" class="form-select">
        <option value="">Todos os períodos</option>
        {% for p in periodos_disponiveis %}
          <option value="{{ p.id }}" {% if periodo_atual and periodo_atual.id == p.id %}selected{% endif %}>
            {{ p.nome }} ({{ p.data_inicio.strftime('%d/%m/%Y') }} – {{ p.data_fim.strftime('%d/%m/%Y') }})
          </option>
        {% endfor %}
      </select>
    </div>
  {% endif %}
  <div class="col-12 col-md-4 d-flex gap-2">
    <button type="submit" class="btn btn-primary mt-auto">Atualizar</button>
    {% if turma %}
      <a href="{{ url_for('turma_calendario', turma_id=turma.id) }}" class="btn btn-outline-secondary mt-auto">Calendário da turma</a>
    {% endif %}
    <a href="{{ url_for('calendario_semana', turma_id=turma.id if turma else None, data=data_base.isoformat(), periodo_id=periodo_atual.id if periodo_atual else None) }}"
       class="btn btn-outline-info mt-auto">
      Calendário semanal
    </a>
  </div>
</form>

<div class="d-flex flex-wrap gap-2 align-items-end mb-3">
  <div class="d-flex align-items-center gap-2">
    <a class="btn btn-outline-primary"
       href="{{ url_for('calendario_semana_previsao', turma_id=turma.id if turma else None, data=semana_anterior.isoformat(), periodo_id=periodo_atual.id if periodo_atual else None, mostrar_todas=1 if mostrar_todas else None) }}">◀ Semana anterior</a>
    <a class="btn btn-outline-primary"
       href="{{ url_for('calendario_semana_previsao', turma_id=turma.id if turma else None, data=semana_seguinte.isoformat(), periodo_id=periodo_atual.id if periodo_atual else None, mostrar_todas=1 if mostrar_todas else None) }}">Semana seguinte ▶</a>
  </div>
  <form method="get" class="d-flex align-items-center gap-2">
    {% if turma %}
      <input type="hidden" name="turma_id" value="{{ turma.id }}">
    {% endif %}
    {% if periodo_atual %}
      <input type="hidden" name="periodo_id" value="{{ periodo_atual.id }}">
    {% endif %}
    {% if mostrar_todas %}
      <input type="hidden" name="mostrar_todas" value="1">
    {% endif %}
    <label class="form-label mb-0">Ir para data:</label>
    <input type="date" name="data" class="form-control" value="{{ data_base.isoformat() }}">
    <button type="submit" class="btn btn-primary">Ir</button>
  </form>
</div>

<div class="floating-nav" aria-label="Navegação semanal fixa">
  <a class="btn btn-outline-primary"
     href="{{ url_for('calendario_semana_previsao', turma_id=turma.id if turma else None, data=semana_anterior.isoformat(), periodo_id=periodo_atual.id if periodo_atual else None, mostrar_todas=1 if mostrar_todas else None) }}">◀ Semana anterior</a>
  <a class="btn btn-outline-primary"
     href="{{ url_for('calendario_semana_previsao', turma_id=turma.id if turma else None, data=semana_seguinte.isoformat(), periodo_id=periodo_atual.id if periodo_atual else None, mostrar_todas=1 if mostrar_todas else None) }}">Semana seguinte ▶</a>
</div>

{% set ns = namespace(editaveis=false) %}
{% for dia in dias_semana %}
  {% for a in aulas_por_data.get(dia, []) %}
    {% if not anos_fechados.get(a.turma_id, False) %}
      {% set ns.editaveis = true %}
    {% endif %}
  {% endfor %}
{% endfor %}

{% if ns.editaveis %}
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h5 class="mb-0">Previsões</h5>
    <button type="button"
            class="btn btn-success js-guardar-todos"
            data-scope="#calendario-previsao-semanal"
            data-loading-text="A guardar todos..."
            data-error-text="Falha ao guardar">
      Guardar todas as previsões
    </button>
  </div>
  <button type="button"
          class="btn btn-success js-guardar-todos floating-guardar"
          data-scope="#calendario-previsao-semanal"
          data-loading-text="A guardar todos..."
          data-error-text="Falha ao guardar"
          aria-label="Guardar todas as previsões visíveis">
    Guardar todas as previsões
  </button>
{% endif %}

<div id="calendario-previsao-semanal">
{% for dia in dias_semana %}
  <div class="p-3 mb-3 rounded-3 border bg-light">
    <h1 class="h4 mb-1">{{ dia.strftime('%d/%m/%Y') }}</h1>
    <div class="text-muted mb-2">{{ ["Seg", "Ter", "Qua", "Qui", "Sex", "Sáb", "Dom"][dia.weekday()] }}</div>
  {% set aulas = aulas_por_data.get(dia, []) %}
  {% if aulas %}
    {% for a in aulas %}
      {% set turma_fechada = anos_fechados.get(a.turma_id, False) %}
      {% set form_id = "previsao-semana-form-" ~ a.id %}
      {% if turma_fechada %}
        <div class="row g-3 align-items-start mb-3">
          <div class="col-12 col-md-3">
            <h2 class="h6 mb-1">Turma {{ a.turma.nome if a.turma else '—' }}</h2>
            <div class="text-muted small">Guardado</div>
          </div>
          <div class="col-12 col-md-9">
            <div class="mb-2">{{ a.previsao|default('')|safe }}</div>
          </div>
        </div>
      {% else %}
        <form method="post"
              id="{{ form_id }}"
              action="{{ url_for('calendario_update_sumario', turma_id=a.turma_id, aula_id=a.id) }}"
              class="js-sumario-form mb-3">
          <input type="hidden" name="view" value="semana_previsao">
          <input type="hidden" name="data_ref" value="{{ semana_inicio.isoformat() }}">
          {% if turma %}
            <input type="hidden" name="turma_id" value="{{ turma.id }}">
          {% endif %}
          {% if periodo_atual %}
            <input type="hidden" name="periodo_id" value="{{ periodo_atual.id }}">
          {% elif a.periodo_id %}
            <input type="hidden" name="periodo_id" value="{{ a.periodo_id }}">
          {% endif %}
          <div class="row g-3 align-items-start">
            <div class="col-12 col-md-3">
              <h2 class="h6 mb-1">Turma {{ a.turma.nome if a.turma else '—' }}</h2>
              <div class="d-flex align-items-center gap-2 text-muted small flex-wrap">
                <span class="sumario-status-dot status-saved js-sumario-status" aria-hidden="true"></span>
                <span class="js-sumario-status-text">Guardado</span>
              </div>
            </div>
            <div class="col-12 col-md-9">
              {% set previsao_id = "previsao-" ~ a.id %}
              <div class="js-richtext-wrapper d-flex flex-column gap-1">
                <div class="richtext-toolbar d-flex flex-wrap align-items-center gap-2">
                  <span class="small text-muted">Formatação:</span>
                  <button type="button" class="btn btn-outline-secondary btn-sm js-richtext-cmd" data-command="bold"><strong>B</strong></button>
                  <button type="button" class="btn btn-outline-secondary btn-sm js-richtext-cmd" data-command="italic"><em>I</em></button>
                  <button type="button" class="btn btn-outline-secondary btn-sm js-richtext-cmd" data-command="backColor" data-value="#fff3cd"><span class="px-1" style="background: #fff3cd;">Realçar</span></button>
                </div>
                <div
                  class="form-control form-control-sm js-richtext-editor richtext-editor"
                  contenteditable="true"
                  data-target="#{{ previsao_id }}"
                  aria-label="Previsão da aula"
                >{{ a.previsao|default('')|safe }}</div>
                <input type="hidden" name="previsao" id="{{ previsao_id }}" value="{{ a.previsao or '' }}">
              </div>
            </div>
          </div>
        </form>
      {% endif %}
    {% endfor %}
  {% else %}
    <div class="alert alert-info">Não existem aulas para esta data.</div>
  {% endif %}
  </div>
{% endfor %}
</div>

{% endblock %}
